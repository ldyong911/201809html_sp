<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
<script>
	//웹소켓 변수
	var webSocket;
	
	//테트리스 화면을 3개로 구성
	//블럭화면, 쌓이는화면, 출력화면
	var arr2d_block = new Array();
	var arr2d_stack = new Array();
	var arr2d_displ = new Array();
	
	//캔버스 그리는법
	var canvas;
	var ctx;
	var arr_ctx_other = new Array();
	
	window.onload = function() {
		init_arr();
		canvas = document.getElementById("canvas");
		if (canvas == null || canvas.getContext == null) return;
		ctx = canvas.getContext("2d");
		
		var canvas_others = document.getElementsByName("canvas_other");
		for(var i=0; i<canvas_others.length; i++){
			var canvas_other = canvas_others[i];
			if (canvas_other == null || canvas_other.getContext == null) return;
			var ctx_other = canvas_other.getContext("2d");
			arr_ctx_other.push(ctx_other);
		}
		
		draw();
	}
	
	//2차원배열 만들어서 0넣기
	function init_arr(){
		for(var i=0; i<20; i++){
			var row_block = new Array();
			var row_stack = new Array();
			var row_displ = new Array();
			for(var j=0; j<10; j++){
				row_block.push(0);
				row_stack.push(0);
				row_displ.push(0);
			}
			arr2d_block.push(row_block);
			arr2d_stack.push(row_stack);
			arr2d_displ.push(row_displ);
		}
		
		arr2d_stack[19][0] = 2;
		arr2d_stack[19][1] = 2;
		arr2d_stack[19][2] = 2;
		arr2d_stack[19][3] = 2;
		arr2d_stack[19][4] = 2;
		arr2d_stack[19][5] = 2;
		arr2d_stack[19][6] = 2;
		arr2d_stack[19][7] = 2;
		
	}
	
	//색깔
	var color = ["black", "yellow", "deepskyblue", "lime", "red", "darkviolet", "blue", "orange"];
	
	//블럭의 모양, 움직였을때 모양, 행값, 열값
	var block_type = 2;
	var block_status = 1;
	var block_i = 0;
	var block_j = 4;
	
	//그림그리기
	function draw() {
		console.log(webSocket);
		if(webSocket != undefined){
			send();
		}
		
		for(var i=0; i<20; i++){
			for(var j=0; j<10; j++){
				var index_color = arr2d_displ[i][j];
				ctx.fillStyle = color[index_color];
				ctx.fillRect(j*20, i*20, 19, 19); // j는 가로, i는 세로
			}
		}
	}
	
	//다른유저의 그림그리기
	function draw_other(info) {
		var arr_info = info.split(":");
		var name_other = arr_info[0];
		var displ_other = arr_info[1];
		var cmd_other = arr_info[2];
		
		if(cmd_other == "ready"){
			return;
		}else if(cmd_other == "start"){
			flag_move = true;
			return;
		}else if(cmd_other == "victo"){
			flag_move = false;
			alert(name_other + "님이 이겼습니다.")
			return;
		}
		
		var obj_div_others = document.getElementsByName("div_other");
		
		//같은방인지체크
		var index_find = -1;
		for(var i=0; i<obj_div_others.length; i++){
			if(name_other == obj_div_others[i].innerHTML){
				index_find = i;
				break;
			}
		}
		
		
		//빈방인지체크
		var index_empty = -1;
		for(var i=0; i<obj_div_others.length; i++){
			if("" == obj_div_others[i].innerHTML){
				index_empty = i;
				break;
			}
		}
		
		console.log(index_find);
		console.log(index_empty);
		
		for(var i=0; i<20; i++){
			for(var j=0; j<10; j++){
				var index_color = displ_other.substring((i*10+j), (i*10+j)+1);
				
				if(index_find == -1){
					var obj_div_other = obj_div_others[index_empty];
					obj_div_other.innerHTML = name_other;
					
					arr_ctx_other[index_empty].fillStyle = color[index_color];
					arr_ctx_other[index_empty].fillRect(j*8, i*8, 7, 7); // j는 가로, i는 세로
				}else{
					arr_ctx_other[index_find].fillStyle = color[index_color];
					arr_ctx_other[index_find].fillRect(j*8, i*8, 7, 7); // j는 가로, i는 세로
				}
			}
		}
	}
	
	var flag_move = false;
	
	function fn_keyboard(e){
		if(!flag_move){
			return;
		}
		
		fn_move(e.keyCode);
	}
	
	function fn_start(){
		var my_initial = document.getElementById("my_initial").value;
		
		if(my_initial.length < 3){
			alert("3글자 이상 입력하세요!");
			return;
		}
		
		//웹소켓
		webSocket = new WebSocket('ws://192.168.206.225/GAMESOCKET/omok');
		
		webSocket.onerror = function(event) {
			onError(event)
		};
		webSocket.onopen = function(event) {
			onOpen(event)
		};
		webSocket.onmessage = function(event) {
			onMessage(event)
		};
		
		//일정시간마다 내려오게
// 		setInterval("fn_move(40)", 500);
	}
	
	function fn_ready(){
		var initial = document.getElementById("my_initial").value;
		webSocket.send(initial + ":" + "___" + ":" + "ready");
	}
	
	//웹소켓
	function onMessage(event) {
		console.log(event.data);
		draw_other(event.data);
	}
	function onOpen(event) {
		document.getElementById("my_connect").innerHTML = "Connection Complete";
		console.log("success: " + event);
	}
	function onError(event) {
		console.log("error: " + event);
	}
	function send() {
		var initial = document.getElementById("my_initial").value;
		var str_arr = "";
		
		for(var i=0; i<arr2d_displ.length; i++){
			for(var j=0; j<arr2d_displ[i].length; j++){
				str_arr += arr2d_displ[i][j];
			}
		}
		
		webSocket.send(initial + ":" + str_arr + ":" + "displ");
	}
	
	//키이벤트
	function fn_move(keycode){
		console.log(keycode);
		
		//블록의 이전상태와 위치값 저장
		var before_status = block_status;
		var before_i = block_i;
		var before_j = block_j;
		
		//32 space, 38 up, 40 down, 37 left, 39 right
		if(keycode == 40){
			block_i++;
		}
		if(keycode == 37){
			block_j--;
		}
		if(keycode == 39){
			block_j++;
		}
		
		if(keycode == 38){
			changeStatus();
		}
		
		//충돌되면 블럭의 상태와 위치값을 이전값으로 셋팅
		var flag = isCollisionWithSetBlock();
		if(flag){
			block_status = before_status;
			block_i = before_i;
			block_j = before_j;
			
			setBlock();
			
			if(keycode == 40){
				goBlockToStack();
				
				checkAndRemoveStack();
				
				//일정높이에 쌓이면 game end
				for(var i=0; i<arr2d_stack[3].length; i++){
					if(arr2d_stack[3][i] != 0){
						alert("game over");
						flag_move = false;
						return;
					}
				}
				
				var rand = parseInt(Math.random() * 7 + 1);
				
				block_type = rand;
				block_status = 1;
				block_i = 1;
				block_j = 4;
				setBlock();
				
				setDispl();
				draw();
			}
			return;
		}
		
		setDispl();
		
		draw();
	}
	
	//한줄이 다차면 제거
	function checkAndRemoveStack(){
		var arr_temp = new Array();
		
		for(var i=0; i<arr2d_displ.length; i++){
			var count10 = 0;
			for(var j=0; j<arr2d_displ[i].length; j++){
				if(arr2d_stack[i][j] != 0){
					count10++;
				}
			}
			
			if(count10 < 10){
				arr_temp.push(arr2d_stack[i]);
			}
		}
		
		var count_refill = arr2d_displ.length - arr_temp.length;
		
		//없앤 횟수 카운트
		var obj_my_count = document.getElementById("my_count");
		var my_count = parseInt(obj_my_count.innerHTML);
		
		my_count = my_count - count_refill;
		obj_my_count.innerHTML = my_count;
		
		if(my_count <= 0){
			var initial = document.getElementById("my_initial").value;
			webSocket.send(initial + ":" + "___" + ":" + "victo");
			alert("Mission Complete");
		}
		//=============
		
		var arr_refill = new Array();
		for(var i=0; i<count_refill; i++){
			arr_refill.push([0,0,0,0,0,0,0,0,0,0]);
		}
		
		arr2d_stack = arr_refill.concat(arr_temp);
	}
	
	//블럭을 쌓이는화면에 쌓이게
	function goBlockToStack(){
		for(var i=0; i<arr2d_displ.length; i++){
			for(var j=0; j<arr2d_displ[i].length; j++){
				if(arr2d_block[i][j] != 0){
					arr2d_stack[i][j] = arr2d_block[i][j];
				}
			}
		}
	}
	
	//충돌체크(블럭화면과 쌓이는화면이 둘다 0이 아니면 충돌)
	function isCollisionWithSetBlock(){
		//밑에 아무것도 없을경우 에러나기때문에
		try {
			setBlock();
		} catch (e) {
			return true;
		}
		
		//밑에 충돌
		for(var i=0; i<arr2d_block.length; i++){
			for(var j=0; j<arr2d_block[i].length; j++){
				if(arr2d_block[i][j] != 0 && arr2d_stack[i][j] != 0){
					return true;
				}
			}
		}
		
		//옆에 충돌
		var count_in=0;
		for(var i=0; i<arr2d_block.length; i++){
			for(var j=0; j<arr2d_block[i].length; j++){
				if(arr2d_block[i][j] != 0){
					count_in++;
				}
			}
		}
		if(count_in < 4){
			return true;
		}
		
		return false;
	}
	
	//움직였을때 모양 셋팅
	function changeStatus(){
		//사각형은 아무것도 안함
		if(block_type == 1){
			
		}else if(block_type == 2 || block_type == 3 || block_type == 4){
			if(block_status == 1){
				block_status = 2;
			}else if(block_status == 2){
				block_status = 1;
			}
		}else if(block_type == 5 || block_type == 6 || block_type == 7){
			if(block_status == 1){
				block_status = 2;
			}else if(block_status == 2){
				block_status = 3;
			}else if(block_status == 3){
				block_status = 4;
			}else if(block_status == 4){
				block_status = 1;
			}
		}
	}
	
	//블럭화면 셋팅
	function setBlock(){
		setZero(arr2d_block);
		
		//1 O, 2 I, 3 S, 4 Z, 5 T, 6 J, 7 L
		if(block_type == 1){
			arr2d_block[block_i		][block_j	] = block_type;
			arr2d_block[block_i		][block_j+1	] = block_type;
			arr2d_block[block_i+1	][block_j	] = block_type;
			arr2d_block[block_i+1	][block_j+1	] = block_type;
		}else if(block_type == 2){
			if(block_status == 1){
				arr2d_block[block_i		][block_j	] = block_type;
				arr2d_block[block_i-1	][block_j	] = block_type;
				arr2d_block[block_i+1	][block_j	] = block_type;
				arr2d_block[block_i+2	][block_j	] = block_type;
			}else if(block_status == 2){
				arr2d_block[block_i	][block_j	] = block_type;
				arr2d_block[block_i	][block_j-1	] = block_type;
				arr2d_block[block_i	][block_j+1	] = block_type;
				arr2d_block[block_i	][block_j+2	] = block_type;
			}
		}else if(block_type == 3){
			if(block_status == 1){
				arr2d_block[block_i		][block_j	] = block_type;
				arr2d_block[block_i		][block_j+1	] = block_type;
				arr2d_block[block_i+1	][block_j	] = block_type;
				arr2d_block[block_i+1	][block_j-1	] = block_type;
			}else if(block_status == 2){
				arr2d_block[block_i		][block_j	] = block_type;
				arr2d_block[block_i-1	][block_j	] = block_type;
				arr2d_block[block_i		][block_j+1	] = block_type;
				arr2d_block[block_i+1	][block_j+1	] = block_type;
			}
		}else if(block_type == 4){
			if(block_status == 1){
				arr2d_block[block_i		][block_j	] = block_type;
				arr2d_block[block_i		][block_j-1	] = block_type;
				arr2d_block[block_i+1	][block_j	] = block_type;
				arr2d_block[block_i+1	][block_j+1	] = block_type;
			}else if(block_status == 2){
				arr2d_block[block_i		][block_j	] = block_type;
				arr2d_block[block_i-1	][block_j	] = block_type;
				arr2d_block[block_i		][block_j-1	] = block_type;
				arr2d_block[block_i+1	][block_j-1	] = block_type;
			}
		}else if(block_type == 5){
			if(block_status == 1){
				arr2d_block[block_i		][block_j	] = block_type;
				arr2d_block[block_i-1	][block_j	] = block_type;
				arr2d_block[block_i		][block_j-1	] = block_type;
				arr2d_block[block_i		][block_j+1	] = block_type;
			}else if(block_status == 2){
				arr2d_block[block_i		][block_j	] = block_type;
				arr2d_block[block_i-1	][block_j	] = block_type;
				arr2d_block[block_i		][block_j+1	] = block_type;
				arr2d_block[block_i+1	][block_j	] = block_type;
			}else if(block_status == 3){
				arr2d_block[block_i		][block_j	] = block_type;
				arr2d_block[block_i		][block_j-1	] = block_type;
				arr2d_block[block_i		][block_j+1	] = block_type;
				arr2d_block[block_i+1	][block_j	] = block_type;
			}else if(block_status == 4){
				arr2d_block[block_i		][block_j	] = block_type;
				arr2d_block[block_i-1	][block_j	] = block_type;
				arr2d_block[block_i		][block_j-1	] = block_type;
				arr2d_block[block_i+1	][block_j	] = block_type;
			}
		}else if(block_type == 6){
			if(block_status == 1){
				arr2d_block[block_i		][block_j	] = block_type;
				arr2d_block[block_i-1	][block_j	] = block_type;
				arr2d_block[block_i+1	][block_j	] = block_type;
				arr2d_block[block_i+1	][block_j-1	] = block_type;
			}else if(block_status == 2){
				arr2d_block[block_i		][block_j	] = block_type;
				arr2d_block[block_i-1	][block_j-1	] = block_type;
				arr2d_block[block_i		][block_j-1	] = block_type;
				arr2d_block[block_i		][block_j+1	] = block_type;
			}else if(block_status == 3){
				arr2d_block[block_i		][block_j	] = block_type;
				arr2d_block[block_i-1	][block_j+1	] = block_type;
				arr2d_block[block_i-1	][block_j	] = block_type;
				arr2d_block[block_i+1	][block_j	] = block_type;
			}else if(block_status == 4){
				arr2d_block[block_i		][block_j	] = block_type;
				arr2d_block[block_i		][block_j-1	] = block_type;
				arr2d_block[block_i		][block_j+1	] = block_type;
				arr2d_block[block_i+1	][block_j+1	] = block_type;
			}
		}else if(block_type == 7){
			if(block_status == 1){
				arr2d_block[block_i		][block_j	] = block_type;
				arr2d_block[block_i-1	][block_j	] = block_type;
				arr2d_block[block_i+1	][block_j	] = block_type;
				arr2d_block[block_i+1	][block_j+1	] = block_type;
			}else if(block_status == 2){
				arr2d_block[block_i		][block_j	] = block_type;
				arr2d_block[block_i+1	][block_j-1	] = block_type;
				arr2d_block[block_i		][block_j-1	] = block_type;
				arr2d_block[block_i		][block_j+1	] = block_type;
			}else if(block_status == 3){
				arr2d_block[block_i		][block_j	] = block_type;
				arr2d_block[block_i-1	][block_j-1	] = block_type;
				arr2d_block[block_i-1	][block_j	] = block_type;
				arr2d_block[block_i+1	][block_j	] = block_type;
			}else if(block_status == 4){
				arr2d_block[block_i		][block_j	] = block_type;
				arr2d_block[block_i-1	][block_j+1	] = block_type;
				arr2d_block[block_i		][block_j+1	] = block_type;
				arr2d_block[block_i		][block_j-1	] = block_type;
			}
		}
	}
	
	//출력화면 셋팅(블럭화면과 쌓이는화면 더해서)
	function setDispl(){
		setZero(arr2d_displ);
		for(var i=0; i<arr2d_displ.length; i++){
			for(var j=0; j<arr2d_displ[i].length; j++){
				if(arr2d_block[i][j] != 0){
					arr2d_displ[i][j] = arr2d_block[i][j];
				}
				
				if(arr2d_stack[i][j] != 0){
					arr2d_displ[i][j] = arr2d_stack[i][j];
				}
			}
		}
	}
	
	//배열을 0으로 셋팅
	function setZero(arr2d){
		for(var i=0; i<arr2d.length; i++){
			for(var j=0; j<arr2d[i].length; j++){
				arr2d[i][j] = 0;
			}
		}
	}
</script>
</head>
<body onkeydown="fn_keyboard(event)">
	<input id="my_initial" maxlength="3"/><br/>
	<input type="button" onclick="fn_start()" value="Connection" />
	<input type="button" onclick="fn_ready()" value="Ready" />
	<div id="my_count">10</div>
	<div id="my_connect">No Connection</div>
	
	<table border="1">
		<tr>
			<td rowspan="4">
				<canvas id="canvas" width="400" height="500">
					이 브라우저는 캔버스를 지원하지 않습니다.
				</canvas>
			</td>
			<td>
				<div name="div_other"></div>
				<canvas name="canvas_other" width="80" height="160">
					이 브라우저는 캔버스를 지원하지 않습니다.
				</canvas>
			</td>
			<td>
				<div name="div_other"></div>
				<canvas name="canvas_other" width="80" height="160">
					이 브라우저는 캔버스를 지원하지 않습니다.
				</canvas>
			</td>
			<td>
				<div name="div_other"></div>
				<canvas name="canvas_other" width="80" height="160">
					이 브라우저는 캔버스를 지원하지 않습니다.
				</canvas>
			</td>
			<td>
				<div name="div_other"></div>
				<canvas name="canvas_other" width="80" height="160">
					이 브라우저는 캔버스를 지원하지 않습니다.
				</canvas>
			</td>
			<td>
				<div name="div_other"></div>
				<canvas name="canvas_other" width="80" height="160">
					이 브라우저는 캔버스를 지원하지 않습니다.
				</canvas>
			</td>
			<td>
				<div name="div_other"></div>
				<canvas name="canvas_other" width="80" height="160">
					이 브라우저는 캔버스를 지원하지 않습니다.
				</canvas>
			</td>
		</tr>
		<tr>
			<td>
				<div name="div_other"></div>
				<canvas name="canvas_other" width="80" height="160">
					이 브라우저는 캔버스를 지원하지 않습니다.
				</canvas>
			</td>
			<td>
				<div name="div_other"></div>
				<canvas name="canvas_other" width="80" height="160">
					이 브라우저는 캔버스를 지원하지 않습니다.
				</canvas>
			</td>
			<td>
				<div name="div_other"></div>
				<canvas name="canvas_other" width="80" height="160">
					이 브라우저는 캔버스를 지원하지 않습니다.
				</canvas>
			</td>
			<td>
				<div name="div_other"></div>
				<canvas name="canvas_other" width="80" height="160">
					이 브라우저는 캔버스를 지원하지 않습니다.
				</canvas>
			</td>
			<td>
				<div name="div_other"></div>
				<canvas name="canvas_other" width="80" height="160">
					이 브라우저는 캔버스를 지원하지 않습니다.
				</canvas>
			</td>
			<td>
				<div name="div_other"></div>
				<canvas name="canvas_other" width="80" height="160">
					이 브라우저는 캔버스를 지원하지 않습니다.
				</canvas>
			</td>
		</tr>
		<tr>
			<td>
				<div name="div_other"></div>
				<canvas name="canvas_other" width="80" height="160">
					이 브라우저는 캔버스를 지원하지 않습니다.
				</canvas>
			</td>
			<td>
				<div name="div_other"></div>
				<canvas name="canvas_other" width="80" height="160">
					이 브라우저는 캔버스를 지원하지 않습니다.
				</canvas>
			</td>
			<td>
				<div name="div_other"></div>
				<canvas name="canvas_other" width="80" height="160">
					이 브라우저는 캔버스를 지원하지 않습니다.
				</canvas>
			</td>
			<td>
				<div name="div_other"></div>
				<canvas name="canvas_other" width="80" height="160">
					이 브라우저는 캔버스를 지원하지 않습니다.
				</canvas>
			</td>
			<td>
				<div name="div_other"></div>
				<canvas name="canvas_other" width="80" height="160">
					이 브라우저는 캔버스를 지원하지 않습니다.
				</canvas>
			</td>
			<td>
				<div name="div_other"></div>
				<canvas name="canvas_other" width="80" height="160">
					이 브라우저는 캔버스를 지원하지 않습니다.
				</canvas>
			</td>
		</tr>
		<tr>
			<td>
				<div name="div_other"></div>
				<canvas name="canvas_other" width="80" height="160">
					이 브라우저는 캔버스를 지원하지 않습니다.
				</canvas>
			</td>
			<td>
				<div name="div_other"></div>
				<canvas name="canvas_other" width="80" height="160">
					이 브라우저는 캔버스를 지원하지 않습니다.
				</canvas>
			</td>
			<td>
				<div name="div_other"></div>
				<canvas name="canvas_other" width="80" height="160">
					이 브라우저는 캔버스를 지원하지 않습니다.
				</canvas>
			</td>
			<td>
				<div name="div_other"></div>
				<canvas name="canvas_other" width="80" height="160">
					이 브라우저는 캔버스를 지원하지 않습니다.
				</canvas>
			</td>
			<td>
				<div name="div_other"></div>
				<canvas name="canvas_other" width="80" height="160">
					이 브라우저는 캔버스를 지원하지 않습니다.
				</canvas>
			</td>
			<td>
				<div name="div_other"></div>
				<canvas name="canvas_other" width="80" height="160">
					이 브라우저는 캔버스를 지원하지 않습니다.
				</canvas>
			</td>
		</tr>
	</table>
</body>
</html>